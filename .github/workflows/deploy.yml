name: Deploy Portfolio

# main 브랜치에 push될 때 자동으로 배포 실행
on:
  push:
    branches: [ main ]
  
# GitHub Pages 배포에 필요한 권한 설정
permissions:
  contents: read    # 코드 읽기 권한
  pages: write      # GitHub Pages 쓰기 권한
  id-token: write   # OIDC 토큰 권한

# 환경 변수 설정
env:
  NODE_VERSION: '18'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: github-pages  # GitHub Pages 환경 설정
    
    steps:
    # 소스 코드 체크아웃
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Node.js 환경 설정
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    # 의존성 설치
    - name: Install dependencies
      run: npm ci
    
    # 프로젝트 빌드
    - name: Build project
      run: npm run build
      env:
        NEXT_PUBLIC_BUILD_ID: ${{ github.sha }}
        NEXT_PUBLIC_BASE_PATH: /craftfolio.json
    
    # 빌드 결과 확인
    - name: Verify build output
      run: |
        echo "빌드 결과 확인:"
        ls -la dist/
        echo "index.html 파일 확인:"
        test -f dist/index.html && echo "✅ index.html 파일 존재" || echo "❌ index.html 파일 없음"
    
    # GitHub Pages 업로드
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      if: github.ref == 'refs/heads/main'
      with:
        path: ./dist
    
    # GitHub Pages에 배포
    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4
      if: github.ref == 'refs/heads/main'
